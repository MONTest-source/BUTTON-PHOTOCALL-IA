<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Photocall</title>
  <style>
    :root { --bg:#0b0b0f; --fg:#e9e9f1; --muted:#b8b8c6; --accent:#00e0ff; }
    html,body { height:100%; margin:0; background:var(--bg); color:var(--fg); font:16px/1.4 Inter, system-ui, Arial; }
    .wrap { min-height:100%; display:grid; place-items:center; padding:24px; }
    .card { width:min(720px, 92vw); border:1px solid #1a1a25; border-radius:16px; padding:24px; text-align:center; }
    h1 { margin:0 0 8px; font-size:28px; }
    p.sub { margin:0 0 24px; color:var(--muted); }
    button { font-size:20px; padding:16px 24px; border-radius:14px; border:2px solid var(--accent); background:transparent; color:var(--fg); cursor:pointer; }
    button:disabled { opacity:.5; cursor:not-allowed; }
    .count { font-size:96px; font-weight:800; margin:20px 0 8px; }
    .hint { color:var(--muted); margin:0 0 16px; }
    #qr { display:none; margin:12px auto 0; width:300px; height:300px; image-rendering:pixelated; }
    .sr-only { position:absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); white-space:nowrap; border:0; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card" role="region" aria-labelledby="title">
      <h1 id="title">Photocall</h1>
      <p class="sub">Pulsa <strong>CAPTURAR</strong>, espera 10 s y escanea el QR</p>

      <button id="btn">ðŸ“¸ CAPTURAR</button>

      <div aria-live="polite" aria-atomic="true">
        <div id="count" class="count" hidden>10</div>
        <p id="hint" class="hint" hidden>Mantente listo, tu foto se estÃ¡ creandoâ€¦</p>
      </div>

      <img id="qr" alt="CÃ³digo QR para descargar tu foto" />
      <p id="error" class="hint" style="color:#ff5d5d;" hidden></p>
      <span class="sr-only" id="live"></span>
    </div>
  </div>

  <script>
    const btn   = document.getElementById('btn');
    const count = document.getElementById('count');
    const hint  = document.getElementById('hint');
    const qrImg = document.getElementById('qr');
    const errEl = document.getElementById('error');
    const live  = document.getElementById('live');

    async function postCapture() {
      const r = await fetch('/api/capture', { method:'POST' });
      if (!r.ok) throw new Error('No se pudo iniciar la captura');
      return r.json(); // { jobId, countdownSec }
    }

    async function getStatus(jobId) {
      const r = await fetch(`/api/status/${jobId}`);
      if (!r.ok) throw new Error('Estado no disponible');
      return r.json();
    }

    function speak(msg){ live.textContent = msg; } // aria-live helper

    btn.addEventListener('click', async () => {
      // Reset UI
      qrImg.style.display = 'none';
      errEl.hidden = true;

      btn.disabled = true;

      try {
        const { jobId, countdownSec } = await postCapture();

        // Countdown UX
        let t = countdownSec ?? 10;
        count.hidden = false; hint.hidden = false;
        const tick = setInterval(() => {
          count.textContent = t;
          speak(`Quedan ${t} segundos`);
          if (--t < 0) clearInterval(tick);
        }, 1000);

        // Polling hasta que estÃ© listo
        const poll = async () => {
          try {
            const s = await getStatus(jobId);
            if (s.status === 'ready' && s.qrPngDataUrl) {
              // Mostrar QR
              count.hidden = true; hint.hidden = true;
              qrImg.src = s.qrPngDataUrl;
              qrImg.style.display = 'block';
              btn.disabled = false;
              return;
            }
            if (s.status === 'failed') throw new Error(s.error || 'Fallo de procesamiento');
          } catch (e) {
            // seguimos intentando un poco mÃ¡s antes de rendirnos
          }
          setTimeout(poll, 1000);
        };
        poll();

      } catch (e) {
        errEl.textContent = e.message || 'Error inesperado';
        errEl.hidden = false;
        btn.disabled = false;
      }
    });
  </script>
</body>
</html>
