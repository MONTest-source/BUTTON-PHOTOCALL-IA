<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content="Captura y escanea el QR de forma fácil y rápida" />
    <title>Photocall IA – Captura y QR</title>
    <link rel="icon" type="image/x-icon" href="pia-favicon.ico" />
    <link rel="stylesheet" href="styles.css" />
</head>

<body>
    <div class="app-container">
        <header class="header">
            <div class="logo-mon"><img src="logo.png" alt="MON Mapping ON" /></div>
            <div class="header-content">
                <h1>Photocall IA</h1>
            </div>
        </header>

        <main class="main-content">
            <div class="content-card">

                <!-- Estado de Captura -->
                <div class="state-idle" id="state-idle">
                    <button class="btn-primary" id="capture-btn">CAPTURAR</button>
                </div>

                <!-- Estado Countdown -->
                <div class="state-countdown hidden" id="state-countdown">
                    <button class="btn-primary" disabled id="progress-text">Procesando... 0%</button>
                </div>

                <!-- Estado Listo para QR -->
                <div class="state-ready hidden" id="state-ready">
                    <button class="btn-primary" disabled>
                        <img id="qr-code-img" src="/qr.png" alt="Código QR para descargar la foto" loading="eager"
                            decoding="async" />
                    </button>
                </div>

                <!-- Estado de Error -->
                <div class="state-error hidden" id="state-error">
                    <p>Ha ocurrido un error inesperado.</p>
                    <button class="btn-primary" id="retry-btn">Reintentar</button>
                </div>

            </div>
        </main>
    </div>

    <script>
        // Helper mínimo (si ya lo tienes en app.js, bórralo de aquí)
        function showState(id) {
            const ids = ["state-idle", "state-countdown", "state-ready", "state-error"];
            ids.forEach(x => document.getElementById(x).classList.add("hidden"));
            document.getElementById(id).classList.remove("hidden");
        }

        const progressText = document.getElementById("progress-text");

        // WebSocket correcto para Render (https -> wss)
        const wsProto = location.protocol === "https:" ? "wss:" : "ws:";
        const wsConnection = new WebSocket(`${wsProto}//${location.host}`);

        wsConnection.onopen = () => console.log("[WS] conectado");
        wsConnection.onerror = (e) => console.log("[WS] error", e);

        wsConnection.onmessage = (event) => {
            let data;
            try { data = JSON.parse(event.data); } catch { return; }

            if (data.type === "progress") {
                const p = Math.max(0, Math.min(1, Number(data.progress ?? 0)));
                const pct = Math.round(p * 100);
                if (progressText) progressText.textContent = `Procesando... ${pct}%`;
                showState("state-countdown");

                // cuando termine (tu threshold real: 0.99)
                if (p >= 0.99) showState("state-ready");
                return;
            }

            if (data.type === "ready") {
                showState("state-ready");
                return;
            }
        };
    </script>
</body>

</html>