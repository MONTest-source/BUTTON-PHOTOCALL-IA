<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Photocall ‚Äì Captura y QR</title>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Anton&family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* ============================================
           DESIGN TOKENS
           ============================================ */
        :root {
            /* Colors - Dark Mode */
            --bg-base: #0B0B0F;
            --text-primary: #E9E9F1;
            --text-secondary: #B8B8C6;
            --accent-cyan: #00E0FF;
            --accent-magenta: #FF2EA1;
            --success: #2EC27E;
            --warning: #F7C948;
            --error: #FF5D5D;
            --border: #1A1A25;
            
            /* Typography */
            --font-heading: 'Anton', -apple-system, BlinkMacSystemFont, sans-serif;
            --font-body: 'Inter', system-ui, -apple-system, sans-serif;
            
            /* Spacing System (8px base) */
            --spacing-4: 4px;
            --spacing-8: 8px;
            --spacing-12: 12px;
            --spacing-16: 16px;
            --spacing-24: 24px;
            --spacing-32: 32px;
            
            /* Border Radius */
            --radius-sm: 12px;
            --radius-md: 14px;
            --radius-lg: 16px;
            
            /* Shadows */
            --shadow-soft: 0 4px 12px rgba(0, 0, 0, 0.3);
            --shadow-qr: 0 8px 24px rgba(0, 224, 255, 0.15);
        }

        /* ============================================
           RESET & BASE
           ============================================ */
        *, *::before, *::after {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html, body {
            height: 100%;
            min-height: 100vh;
            overflow-x: hidden;
            overflow-y: auto;
            -webkit-tap-highlight-color: transparent;
            -webkit-overflow-scrolling: touch;
        }

        body {
            background-color: var(--bg-base);
            color: var(--text-primary);
            font-family: var(--font-body);
            font-size: 16px;
            line-height: 1.5;
            display: flex;
            flex-direction: column;
            padding: var(--spacing-24);
            position: relative;
            overflow-x: hidden;
            overflow-y: auto;
        }

        /* Canvas para animaci√≥n de olas */
        #waves-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            pointer-events: none;
        }

        /* ============================================
           LAYOUT - GRID 12 COLUMNS
           ============================================ */
        .app-container {
            max-width: 1024px;
            width: 100%;
            margin: 0 auto;
            display: grid;
            grid-template-columns: repeat(12, 1fr);
            gap: var(--spacing-16);
            height: 100%;
            align-content: space-between;
        }

        /* ============================================
           HEADER
           ============================================ */
        .header {
            grid-column: 1 / -1;
            display: flex;
            align-items: center;
            gap: var(--spacing-16);
            padding-bottom: var(--spacing-24);
            border-bottom: 1px solid var(--border);
        }

        .logo-placeholder {
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, var(--accent-cyan), var(--accent-magenta));
            border-radius: var(--radius-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            font-weight: 700;
            color: var(--bg-base);
        }

        .header-content h1 {
            font-family: var(--font-heading);
            font-size: 40px;
            font-weight: 400;
            line-height: 1;
            color: var(--text-primary);
            margin-bottom: var(--spacing-4);
        }

        .header-content .subtitle {
            font-size: 14px;
            color: var(--text-secondary);
            font-weight: 400;
        }

        /* ============================================
           MAIN CONTENT AREA
           ============================================ */
        .main-content {
            grid-column: 1 / -1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 0;
            flex: 1;
        }

        .content-card {
            width: 100%;
            max-width: 600px;
            background: transparent;
            border: none;
            border-radius: var(--radius-lg);
            padding: var(--spacing-32);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: var(--spacing-24);
        }

        /* ============================================
           BUTTON COMPONENT - PRIMARY (SQUARE) - 3D DESIGN ENHANCED
           ============================================ */
        .btn-primary {
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 400px;
            height: 400px;
            border-radius: var(--radius-lg);
            border: none;
            background: linear-gradient(145deg, #0F0F15, #08080C);
            color: var(--text-primary);
            font-family: var(--font-body);
            cursor: pointer;
            transition: transform 0.15s cubic-bezier(0.4, 0, 0.2, 1), box-shadow 0.15s ease;
            overflow: hidden;
            padding: var(--spacing-24);
            isolation: isolate;
            outline: none !important;
            opacity: 1 !important; /* Siempre s√≥lido */
            
            /* Efecto 3D intensificado con m√∫ltiples sombras */
            box-shadow: 
                /* Sombras exteriores profundas (elevaci√≥n 3D) */
                0 12px 24px rgba(0, 0, 0, 0.8),
                0 8px 16px rgba(0, 0, 0, 0.6),
                0 4px 8px rgba(0, 0, 0, 0.4),
                /* Sombras interiores superiores (bevel pronunciado) */
                inset 0 4px 8px rgba(0, 224, 255, 0.2),
                inset 0 2px 4px rgba(255, 255, 255, 0.15),
                inset 0 -2px 4px rgba(0, 0, 0, 0.3),
                /* Borde ne√≥n con glow intenso */
                0 0 0 3px rgba(0, 224, 255, 0.4),
                0 0 30px rgba(0, 224, 255, 0.3),
                0 0 60px rgba(0, 224, 255, 0.15);
        }

        /* Capa de borde ne√≥n animado */
        .btn-primary::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            border-radius: var(--radius-lg);
            padding: 3px;
            background: linear-gradient(135deg, 
                rgba(0, 224, 255, 0.9) 0%,
                rgba(255, 46, 161, 0.7) 50%,
                rgba(0, 224, 255, 0.9) 100%);
            -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            -webkit-mask-composite: xor;
            mask-composite: exclude;
            opacity: 0.7;
            z-index: -1;
            transition: opacity 0.2s ease;
        }

        .btn-primary:focus {
            outline: none !important;
        }

        /* Efecto de luz que sigue el cursor */
        .btn-primary::before {
            content: '';
            position: absolute;
            width: 75%; /* Proporcional al bot√≥n */
            height: 75%; /* Proporcional al bot√≥n */
            max-width: 300px;
            max-height: 300px;
            background: radial-gradient(circle, 
                rgba(0, 224, 255, 0.5) 0%,
                rgba(0, 224, 255, 0.3) 30%,
                rgba(255, 46, 161, 0.2) 50%,
                transparent 70%);
            border-radius: 50%;
            pointer-events: none;
            z-index: 0;
            opacity: 0;
            left: var(--cursor-x, 50%);
            top: var(--cursor-y, 50%);
            transform: translate(-50%, -50%) scale(0.8);
            transition: opacity 0.2s ease;
            will-change: transform, opacity, left, top;
        }

        /* Hover: Elevaci√≥n 3D aumentada */
        .btn-primary:hover:not(:disabled) {
            transform: translateY(-6px) scale(1.02);
            background: linear-gradient(145deg, #121218, #0A0A0F);
            box-shadow: 
                /* Sombras exteriores m√°s pronunciadas */
                0 16px 32px rgba(0, 0, 0, 0.9),
                0 12px 24px rgba(0, 0, 0, 0.7),
                0 6px 12px rgba(0, 0, 0, 0.5),
                /* Glow ne√≥n intensificado */
                0 0 50px rgba(0, 224, 255, 0.5),
                0 0 80px rgba(0, 224, 255, 0.3),
                0 0 120px rgba(0, 224, 255, 0.15),
                /* Bevel interior m√°s pronunciado */
                inset 0 5px 10px rgba(0, 224, 255, 0.25),
                inset 0 2px 5px rgba(255, 255, 255, 0.2),
                inset 0 -3px 6px rgba(0, 0, 0, 0.4),
                /* Borde brillante */
                0 0 0 3px rgba(0, 224, 255, 0.7);
        }

        .btn-primary:hover:not(:disabled)::after {
            opacity: 0.9;
        }

        .btn-primary:hover:not(:disabled)::before {
            opacity: 1;
        }

        /* Active: Efecto de presi√≥n 3D */
        .btn-primary:active:not(:disabled) {
            transform: translateY(-2px) scale(0.99);
            box-shadow: 
                /* Sombras reducidas (bot√≥n presionado) */
                0 6px 12px rgba(0, 0, 0, 0.7),
                0 3px 6px rgba(0, 0, 0, 0.5),
                /* Sombra interior profunda (presi√≥n 3D) */
                inset 0 6px 12px rgba(0, 0, 0, 0.6),
                inset 0 3px 6px rgba(0, 0, 0, 0.4),
                inset 0 -2px 4px rgba(0, 0, 0, 0.3),
                /* Glow reducido */
                0 0 30px rgba(0, 224, 255, 0.4),
                0 0 0 3px rgba(0, 224, 255, 0.5);
            background: linear-gradient(145deg, #0A0A0F, #0F0F15);
        }

        /* Contenedor de part√≠culas - siempre visible cuando hay cursor */
        .particles {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            display: block;
            z-index: 1;
            opacity: 0;
            transition: opacity 0.2s ease;
        }

        .btn-primary:hover:not(:disabled) .particles {
            opacity: 1;
        }

        .particle {
            position: absolute;
            width: 6px;
            height: 6px;
            background: #00E0FF;
            border-radius: 50%;
            opacity: 0;
            box-shadow: 
                0 0 8px rgba(0, 224, 255, 1),
                0 0 16px rgba(0, 224, 255, 0.6),
                0 0 24px rgba(0, 224, 255, 0.3);
            animation: particleFloat 1.5s ease-out forwards;
            pointer-events: none;
        }

        @keyframes particleFloat {
            0% {
                transform: translate(0, 0) scale(0);
                opacity: 1;
            }
            50% {
                transform: translate(var(--tx, 0), var(--ty, 0)) scale(1.5);
                opacity: 0.8;
            }
            100% {
                transform: translate(var(--tx, 0), var(--ty, 0)) scale(0);
                opacity: 0;
            }
        }

        /* Efecto de ondas al hacer clic */
        .click-ripple {
            position: absolute;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: radial-gradient(circle, 
                rgba(0, 224, 255, 0.6) 0%,
                rgba(255, 46, 161, 0.4) 50%,
                transparent 70%);
            transform: translate(-50%, -50%);
            pointer-events: none;
            z-index: 1;
            animation: rippleExpand 0.6s ease-out forwards;
        }

        @keyframes rippleExpand {
            0% {
                width: 0;
                height: 0;
                opacity: 1;
            }
            100% {
                width: 400px;
                height: 400px;
                opacity: 0;
            }
        }

        .btn-primary:focus-visible {
            outline: 3px solid var(--accent-cyan);
            outline-offset: 4px;
        }

        /* Disabled: Mantiene efecto 3D pero deshabilitado */
        .btn-primary:disabled {
            opacity: 1 !important; /* Siempre s√≥lido */
            cursor: not-allowed;
            pointer-events: none;
            background: linear-gradient(145deg, #0A0A0F, #08080C);
            transform: none;
            box-shadow: 
                0 6px 12px rgba(0, 0, 0, 0.6),
                0 3px 6px rgba(0, 0, 0, 0.4),
                inset 0 2px 4px rgba(0, 0, 0, 0.3),
                0 0 0 2px rgba(0, 224, 255, 0.2),
                0 0 15px rgba(0, 224, 255, 0.15);
        }

        .btn-primary:disabled::after {
            opacity: 0.3;
        }

        .btn-primary:disabled::before {
            opacity: 0;
        }

        .btn-primary:disabled .particles {
            opacity: 0;
        }

        /* Contenido dentro del bot√≥n */
        .btn-content {
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 100%;
            gap: var(--spacing-8);
            z-index: 2; /* Por encima de los efectos ::before y ::after */
            padding: var(--spacing-8);
            box-sizing: border-box;
        }

        .btn-text {
            position: relative;
            font-size: 20px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: block;
            text-align: center;
            text-shadow: 
                0 2px 4px rgba(0, 0, 0, 0.5),
                0 0 10px rgba(0, 224, 255, 0.3);
            z-index: 3;
        }

        .btn-icon {
            position: relative;
            font-size: 64px;
            display: block;
            margin-top: var(--spacing-8);
            text-align: center;
            filter: drop-shadow(0 0 10px rgba(0, 224, 255, 0.6)) drop-shadow(0 2px 4px rgba(0, 0, 0, 0.5));
            z-index: 3;
        }

        /* Countdown dentro del bot√≥n */
        .btn-countdown {
            font-family: var(--font-body);
            font-size: 120px;
            font-weight: 700;
            color: var(--accent-cyan);
            line-height: 1;
            text-align: center;
            font-variant-numeric: tabular-nums;
            text-shadow: 0 0 20px rgba(0, 224, 255, 0.5);
        }

        /* Mensaje dentro del bot√≥n */
        .btn-message {
            font-size: 14px;
            font-weight: 500;
            color: #E9E9F1;
            text-align: center;
            max-width: 90%;
            line-height: 1.5;
            margin-top: var(--spacing-12);
            text-shadow: 
                0 2px 6px rgba(0, 0, 0, 0.7),
                0 0 15px rgba(0, 224, 255, 0.3);
            padding: 0 var(--spacing-8);
        }

        /* QR dentro del bot√≥n */
        .btn-qr-container {
            width: 100%;
            max-width: 180px;
            height: 180px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #FFFFFF;
            border-radius: var(--radius-sm);
            padding: var(--spacing-10);
            box-sizing: border-box;
            position: relative;
            overflow: visible;
            margin: var(--spacing-8) 0;
            box-shadow: 
                0 4px 12px rgba(0, 0, 0, 0.4),
                0 0 20px rgba(0, 224, 255, 0.2),
                inset 0 0 10px rgba(0, 0, 0, 0.05);
        }

        .btn-qr-container img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            display: block;
            transition: transform 0.3s ease;
        }

        /* Animaci√≥n especial cuando aparece el QR */
        .btn-qr-container.qr-appearing {
            animation: qrPulse 1.5s ease-out;
        }

        .btn-qr-container.qr-appearing img {
            animation: qrZoom 1.5s ease-out, qrGlow 2s ease-out;
        }

        @keyframes qrPulse {
            0% {
                transform: scale(0.3);
                opacity: 0;
                box-shadow: 0 0 0 0 rgba(0, 224, 255, 0.8);
            }
            50% {
                transform: scale(1.15);
                box-shadow: 0 0 40px 20px rgba(0, 224, 255, 0.6),
                            0 0 80px 40px rgba(255, 46, 161, 0.4);
            }
            100% {
                transform: scale(1);
                opacity: 1;
                box-shadow: 0 0 20px 10px rgba(0, 224, 255, 0.3);
            }
        }

        @keyframes qrZoom {
            0% {
                transform: scale(0.5) rotate(-10deg);
            }
            50% {
                transform: scale(1.1) rotate(5deg);
            }
            100% {
                transform: scale(1) rotate(0deg);
            }
        }

        @keyframes qrGlow {
            0%, 100% {
                filter: brightness(1) drop-shadow(0 0 0 rgba(0, 224, 255, 0));
            }
            25% {
                filter: brightness(1.3) drop-shadow(0 0 15px rgba(0, 224, 255, 0.8))
                        drop-shadow(0 0 30px rgba(255, 46, 161, 0.6));
            }
            50% {
                filter: brightness(1.5) drop-shadow(0 0 20px rgba(0, 224, 255, 1))
                        drop-shadow(0 0 40px rgba(255, 46, 161, 0.8));
            }
            75% {
                filter: brightness(1.2) drop-shadow(0 0 10px rgba(0, 224, 255, 0.6));
            }
        }

        /* Efecto de ondas conc√©ntricas cuando aparece el QR */
        .qr-ripple {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            border: 3px solid rgba(0, 224, 255, 0.6);
            transform: translate(-50%, -50%);
            animation: rippleExpand 1.5s ease-out;
            pointer-events: none;
        }

        @keyframes rippleExpand {
            0% {
                width: 0;
                height: 0;
                opacity: 1;
            }
            100% {
                width: 400px;
                height: 400px;
                opacity: 0;
            }
        }

        /* ============================================
           ANIMACI√ìN DE REINICIO
           ============================================ */
        .reset-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10000;
            pointer-events: none;
            opacity: 0;
        }

        .reset-overlay.active {
            animation: resetFlash 1.2s ease-out;
        }

        @keyframes resetFlash {
            0% {
                opacity: 0;
            }
            10% {
                opacity: 1;
                background: radial-gradient(circle at center, 
                    rgba(0, 224, 255, 0.9) 0%,
                    rgba(255, 46, 161, 0.7) 30%,
                    rgba(0, 0, 0, 0.8) 60%,
                    rgba(0, 0, 0, 0.95) 100%);
            }
            30% {
                background: radial-gradient(circle at center, 
                    rgba(0, 224, 255, 0.6) 0%,
                    rgba(255, 46, 161, 0.5) 40%,
                    rgba(0, 0, 0, 0.6) 70%,
                    rgba(0, 0, 0, 0.9) 100%);
            }
            50% {
                opacity: 0.8;
                background: linear-gradient(135deg,
                    rgba(0, 224, 255, 0.4) 0%,
                    rgba(255, 46, 161, 0.3) 50%,
                    rgba(0, 224, 255, 0.4) 100%);
            }
            70% {
                opacity: 0.4;
                background: rgba(0, 224, 255, 0.2);
            }
            100% {
                opacity: 0;
                background: transparent;
            }
        }

        /* C√≠rculo de reinicio que se expande */
        .reset-circle {
            position: fixed;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            background: radial-gradient(circle,
                rgba(0, 224, 255, 0.8) 0%,
                rgba(255, 46, 161, 0.6) 40%,
                transparent 70%);
            pointer-events: none;
            z-index: 10001;
            opacity: 0;
        }

        .reset-circle.active {
            animation: resetCircleExpand 1.2s ease-out;
        }

        @keyframes resetCircleExpand {
            0% {
                width: 0;
                height: 0;
                opacity: 1;
                box-shadow: 0 0 0 0 rgba(0, 224, 255, 0.8),
                            0 0 0 0 rgba(255, 46, 161, 0.6);
            }
            30% {
                width: 200px;
                height: 200px;
                opacity: 0.9;
                box-shadow: 0 0 50px 30px rgba(0, 224, 255, 0.6),
                            0 0 100px 60px rgba(255, 46, 161, 0.4);
            }
            60% {
                width: 800px;
                height: 800px;
                opacity: 0.6;
                box-shadow: 0 0 100px 80px rgba(0, 224, 255, 0.4),
                            0 0 200px 120px rgba(255, 46, 161, 0.3);
            }
            100% {
                width: 2000px;
                height: 2000px;
                opacity: 0;
                box-shadow: 0 0 150px 100px rgba(0, 224, 255, 0),
                            0 0 300px 200px rgba(255, 46, 161, 0);
            }
        }

        /* Barrido de reinicio */
        .reset-sweep {
            position: fixed;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg,
                transparent 0%,
                rgba(0, 224, 255, 0.6) 30%,
                rgba(255, 46, 161, 0.6) 50%,
                rgba(0, 224, 255, 0.6) 70%,
                transparent 100%);
            pointer-events: none;
            z-index: 10002;
            opacity: 0;
        }

        .reset-sweep.active {
            animation: resetSweep 1.2s ease-out;
        }

        @keyframes resetSweep {
            0% {
                left: -100%;
                opacity: 0;
            }
            20% {
                opacity: 0.8;
            }
            50% {
                left: 0%;
                opacity: 1;
            }
            80% {
                opacity: 0.6;
            }
            100% {
                left: 100%;
                opacity: 0;
            }
        }

        /* Mensaje de reinicio */
        .reset-message {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.5);
            font-family: var(--font-heading);
            font-size: 48px;
            color: var(--accent-cyan);
            text-shadow: 0 0 20px rgba(0, 224, 255, 0.8),
                         0 0 40px rgba(0, 224, 255, 0.6),
                         0 0 60px rgba(255, 46, 161, 0.4);
            pointer-events: none;
            z-index: 10003;
            opacity: 0;
            white-space: nowrap;
        }

        .reset-message.active {
            animation: resetMessage 1.2s ease-out;
        }

        @keyframes resetMessage {
            0% {
                opacity: 0;
                transform: translate(-50%, -50%) scale(0.3) rotate(-10deg);
            }
            30% {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1.1) rotate(5deg);
            }
            50% {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1) rotate(0deg);
            }
            70% {
                opacity: 0.8;
                transform: translate(-50%, -50%) scale(0.95) rotate(-2deg);
            }
            100% {
                opacity: 0;
                transform: translate(-50%, -50%) scale(0.8) rotate(5deg);
            }
        }

        /* Spinner de carga */
        .loading-spinner {
            width: 80px;
            height: 80px;
            margin: var(--spacing-16) auto;
            position: relative;
            display: none;
        }

        .loading-spinner.active {
            display: block;
        }

        .spinner-ring {
            position: absolute;
            width: 100%;
            height: 100%;
            border: 4px solid transparent;
            border-top-color: var(--accent-cyan);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .spinner-ring:nth-child(2) {
            width: 70%;
            height: 70%;
            top: 15%;
            left: 15%;
            border-top-color: var(--accent-magenta);
            animation: spin 1.2s linear infinite reverse;
        }

        .spinner-ring:nth-child(3) {
            width: 40%;
            height: 40%;
            top: 30%;
            left: 30%;
            border-top-color: var(--accent-cyan);
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }
            100% {
                transform: rotate(360deg);
            }
        }

        /* Glow del spinner */
        .loading-spinner::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: radial-gradient(circle,
                rgba(0, 224, 255, 0.3) 0%,
                rgba(255, 46, 161, 0.2) 50%,
                transparent 100%);
            animation: pulseGlow 1.5s ease-in-out infinite;
        }

        @keyframes pulseGlow {
            0%, 100% {
                opacity: 0.6;
                transform: translate(-50%, -50%) scale(1);
            }
            50% {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1.2);
            }
        }

        /* T√≠tulo dentro del bot√≥n cuando hay QR */
        .btn-qr-title {
            font-family: var(--font-heading);
            font-size: 18px;
            font-weight: 600;
            color: #FFFFFF;
            text-align: center;
            margin-bottom: var(--spacing-12);
            width: 100%;
            text-shadow: 
                0 2px 8px rgba(0, 0, 0, 0.8),
                0 0 20px rgba(0, 224, 255, 0.4),
                0 0 30px rgba(255, 46, 161, 0.3);
            letter-spacing: 0.5px;
            line-height: 1.3;
        }

        /* Button Secondary */
        .btn-secondary {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: var(--spacing-12) var(--spacing-16);
            background: transparent;
            border: none;
            color: var(--accent-cyan);
            font-family: var(--font-body);
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            text-decoration: underline;
            text-underline-offset: 4px;
            transition: color 0.2s ease;
        }

        .btn-secondary:hover {
            color: var(--accent-magenta);
        }

        .btn-secondary:focus-visible {
            outline: 2px solid var(--accent-cyan);
            outline-offset: 4px;
            border-radius: 4px;
        }


        /* ============================================
           QR CARD COMPONENT
           ============================================ */
        .qr-card {
            width: 100%;
            max-width: 360px;
            background: transparent;
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            padding: var(--spacing-24);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: var(--spacing-16);
            box-shadow: var(--shadow-qr);
        }

        .qr-card h2 {
            font-family: var(--font-heading);
            font-size: 28px;
            font-weight: 400;
            color: var(--text-primary);
            text-align: center;
            margin: 0;
        }

        .qr-image-container {
            width: 300px;
            height: 300px;
            background: #FFFFFF;
            border-radius: var(--radius-sm);
            padding: var(--spacing-16);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .qr-image-container img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .qr-caption {
            font-size: 14px;
            color: var(--text-secondary);
            text-align: center;
        }

        /* ============================================
           NOTE / HELPER TEXT
           ============================================ */
        .note-text {
            font-size: 14px;
            color: var(--text-secondary);
            text-align: center;
            max-width: 500px;
        }

        /* ============================================
           ERROR STATE
           ============================================ */
        .error-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: var(--spacing-24);
        }

        .error-icon {
            width: 64px;
            height: 64px;
            border-radius: 50%;
            background: rgba(255, 93, 93, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            color: var(--error);
        }

        .error-message {
            font-size: 16px;
            color: var(--text-primary);
            text-align: center;
        }

        /* ============================================
           TOAST COMPONENT
           ============================================ */
        .toast {
            position: fixed;
            bottom: var(--spacing-24);
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            align-items: center;
            gap: var(--spacing-12);
            padding: var(--spacing-12) var(--spacing-16);
            border-radius: var(--radius-sm);
            font-size: 14px;
            font-weight: 500;
            z-index: 1000;
            animation: slideUp 0.3s ease;
            max-width: 90%;
        }

        .toast.success {
            background: #062917;
            color: #E6FFF2;
            border: 1px solid rgba(46, 194, 126, 0.3);
        }

        .toast.error {
            background: #2B0909;
            color: #FFE9E9;
            border: 1px solid rgba(255, 93, 93, 0.3);
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateX(-50%) translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
        }

        /* ============================================
           FOOTER
           ============================================ */
        .footer {
            grid-column: 1 / -1;
            padding-top: var(--spacing-24);
            border-top: 1px solid var(--border);
        }

        .footer-text {
            font-size: 12px;
            color: var(--text-secondary);
            text-align: center;
            line-height: 1.5;
        }

        /* ============================================
           UTILITY CLASSES
           ============================================ */
        .hidden {
            display: none !important;
        }

        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border-width: 0;
        }

        /* ============================================
           STATES
           ============================================ */
        .state-idle,
        .state-countdown,
        .state-ready,
        .state-error {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: var(--spacing-24);
            width: 100%;
        }

        /* ============================================
           RESPONSIVE - TABLET LANDSCAPE (1024√ó768, 1366√ó768)
           ============================================ */
        @media (min-width: 768px) and (max-width: 1366px) and (orientation: landscape) {
            body {
                padding: var(--spacing-16);
            }

            .app-container {
                padding: 0;
                max-width: 100%;
            }

            .header {
                padding-bottom: var(--spacing-16);
                margin-bottom: var(--spacing-8);
            }

            .header-content h1 {
                font-size: 36px;
            }

            .header-content .subtitle {
                font-size: 13px;
            }

            .main-content {
                min-height: calc(100vh - 200px);
            }

            .btn-primary {
                width: 380px;
                height: 380px;
            }

            .btn-text {
                font-size: 22px;
            }

            .btn-icon {
                font-size: 56px;
            }

            .btn-countdown {
                font-size: 110px;
            }

            .btn-message {
                font-size: 16px;
            }

            .btn-qr-container {
                max-width: 220px;
                height: 220px;
                padding: var(--spacing-10);
                margin: var(--spacing-8) 0;
            }

            .btn-primary::before {
                width: 75%;
                height: 75%;
                max-width: 285px;
                max-height: 285px;
            }

            .btn-qr-title {
                font-size: 20px;
                font-weight: 600;
                margin-bottom: var(--spacing-12);
            }

            .btn-message {
                font-size: 15px;
                margin-top: var(--spacing-12);
            }

            .note-text {
                font-size: 13px;
                max-width: 450px;
            }

            .footer {
                padding-top: var(--spacing-16);
                margin-top: var(--spacing-16);
            }

            .footer-text {
                font-size: 11px;
            }
        }

        /* ============================================
           RESPONSIVE - TABLET PORTRAIT (768√ó1024, 820√ó1180)
           ============================================ */
        @media (min-width: 768px) and (max-width: 1024px) and (orientation: portrait) {
            body {
                padding: var(--spacing-12);
            }

            .app-container {
                padding: 0;
                max-width: 100%;
                gap: var(--spacing-12);
            }

            .header {
                padding-bottom: var(--spacing-12);
                margin-bottom: var(--spacing-8);
                flex-wrap: wrap;
            }

            .logo-placeholder {
                width: 40px;
                height: 40px;
                font-size: 20px;
            }

            .header-content h1 {
                font-size: 32px;
            }

            .header-content .subtitle {
                font-size: 12px;
            }

            .main-content {
                min-height: calc(100vh - 180px);
                justify-content: center;
            }

            .content-card {
                padding: var(--spacing-24);
                gap: var(--spacing-20);
            }

            .btn-primary {
                width: 320px;
                height: 320px;
                padding: var(--spacing-20);
            }

            .btn-text {
                font-size: 20px;
            }

            .btn-icon {
                font-size: 48px;
            }

            .btn-countdown {
                font-size: 90px;
            }

            .btn-message {
                font-size: 15px;
                padding: 0 var(--spacing-16);
            }

            .btn-qr-container {
                max-width: 200px;
                height: 200px;
                padding: var(--spacing-8);
                margin: var(--spacing-8) 0;
            }

            .btn-primary::before {
                width: 75%;
                height: 75%;
                max-width: 240px;
                max-height: 240px;
            }

            .btn-qr-title {
                font-size: 18px;
                font-weight: 600;
                margin-bottom: var(--spacing-10);
            }

            .btn-message {
                font-size: 14px;
                margin-top: var(--spacing-10);
            }

            .qr-caption {
                font-size: 12px;
            }

            .note-text {
                font-size: 12px;
                max-width: 400px;
            }

            .footer {
                padding-top: var(--spacing-12);
                margin-top: var(--spacing-12);
            }

            .footer-text {
                font-size: 10px;
            }
        }

        /* ============================================
           RESPONSIVE - TABLET SMALL LANDSCAPE (800√ó600, 1024√ó600)
           ============================================ */
        @media (min-width: 800px) and (max-width: 1024px) and (orientation: landscape) {
            .btn-primary {
                width: 340px;
                height: 340px;
            }

            .btn-countdown {
                font-size: 95px;
            }

            .btn-qr-container {
                max-width: 210px;
                height: 210px;
                padding: var(--spacing-8);
                margin: var(--spacing-8) 0;
            }

            .btn-primary::before {
                width: 75%;
                height: 75%;
                max-width: 255px;
                max-height: 255px;
            }
        }

        /* ============================================
           RESPONSIVE - MOBILE & SMALL TABLETS
           ============================================ */
        @media (max-width: 767px) {
            body {
                padding: var(--spacing-12);
            }

            .app-container {
                padding: 0;
                gap: var(--spacing-12);
            }

            .header {
                padding-bottom: var(--spacing-12);
                flex-wrap: wrap;
            }

            .logo-placeholder {
                width: 36px;
                height: 36px;
                font-size: 18px;
            }

            .header-content h1 {
                font-size: 28px;
            }

            .header-content .subtitle {
                font-size: 11px;
            }

            .main-content {
                min-height: calc(100vh - 160px);
            }

            .content-card {
                padding: var(--spacing-20);
                gap: var(--spacing-16);
            }

            .btn-primary {
                width: min(280px, 85vw);
                height: min(280px, 85vw);
                padding: var(--spacing-16);
            }

            .btn-text {
                font-size: 18px;
            }

            .btn-icon {
                font-size: 40px;
            }

            .btn-countdown {
                font-size: 72px;
            }

            .btn-message {
                font-size: 14px;
                padding: 0 var(--spacing-12);
            }

            .btn-qr-container {
                max-width: min(170px, 60vw);
                height: min(170px, 60vw);
                padding: var(--spacing-8);
                margin: var(--spacing-8) 0;
            }

            .btn-primary::before {
                width: 75%;
                height: 75%;
                max-width: 210px;
                max-height: 210px;
            }

            .btn-qr-title {
                font-size: 17px;
                font-weight: 600;
                margin-bottom: var(--spacing-10);
            }

            .btn-message {
                font-size: 13px;
                margin-top: var(--spacing-10);
            }

            .qr-caption {
                font-size: 11px;
            }

            .note-text {
                font-size: 11px;
                max-width: 90%;
            }

            .footer {
                padding-top: var(--spacing-12);
            }

            .footer-text {
                font-size: 10px;
            }
        }

        /* ============================================
           RESPONSIVE - VERY SMALL SCREENS
           ============================================ */
        @media (max-width: 480px) {
            body {
                padding: var(--spacing-8);
            }

            .header-content h1 {
                font-size: 24px;
            }

            .btn-primary {
                width: min(240px, 80vw);
                height: min(240px, 80vw);
            }

            .btn-countdown {
                font-size: 64px;
            }

            .btn-qr-container {
                max-width: min(150px, 55vw);
                height: min(150px, 55vw);
                padding: var(--spacing-6);
                margin: var(--spacing-8) 0;
            }

            .btn-primary::before {
                width: 75%;
                height: 75%;
                max-width: 180px;
                max-height: 180px;
            }
        }

        /* ============================================
           HIGH CONTRAST MODE (Optional)
           ============================================ */
        @media (prefers-contrast: high) {
            :root {
                --bg-base: #FFFFFF;
                --text-primary: #000000;
                --text-secondary: #333333;
                --accent-cyan: #0B0B0F;
                --border: #000000;
            }

            body {
                background: var(--bg-base);
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- HEADER -->
        <header class="header" role="banner">
            <div class="logo-placeholder" aria-hidden="true">P</div>
            <div class="header-content">
                <h1>Photocall</h1>
                <p class="subtitle">Pulsa CAPTURAR, espera 10 s y escanea el QR</p>
            </div>
        </header>

        <!-- MAIN CONTENT -->
        <main class="main-content" role="main">
            <div class="content-card">
                <!-- STATE: IDLE -->
                <div class="state-idle" id="state-idle" role="region" aria-label="Estado inicial">
                    <button class="btn-primary" id="capture-btn" aria-label="Iniciar captura de foto">
                        <div class="particles" id="particles-container"></div>
                        <div class="btn-content">
                            <div class="btn-text">CAPTURAR</div>
                            <div class="btn-icon" aria-hidden="true">üì∏</div>
                        </div>
                    </button>
                    <p class="note-text" aria-live="polite" style="margin-top: var(--spacing-24);">
                        La descarga se har√° mediante un c√≥digo QR.
                    </p>
                </div>

                <!-- STATE: COUNTDOWN (dentro del bot√≥n) -->
                <div class="state-countdown hidden" id="state-countdown" role="region" aria-label="Cuenta atr√°s">
                    <button class="btn-primary" disabled aria-label="Captura en progreso">
                        <div class="btn-content">
                            <div class="btn-countdown" id="countdown-display" 
                                 role="timer" 
                                 aria-live="assertive" 
                                 aria-atomic="true"
                                 aria-label="Cuenta atr√°s en segundos">
                                10
                            </div>
                            <p class="btn-message" id="countdown-message" aria-live="polite">
                                Mantente listo, tu foto se est√° creando‚Ä¶
                            </p>
                            <div class="loading-spinner" id="loading-spinner" role="status" aria-label="Cargando imagen">
                                <div class="spinner-ring"></div>
                                <div class="spinner-ring"></div>
                                <div class="spinner-ring"></div>
                            </div>
                        </div>
                    </button>
                </div>

                <!-- STATE: READY (dentro del bot√≥n) -->
                <div class="state-ready hidden" id="state-ready" role="region" aria-label="Foto lista">
                    <button class="btn-primary" disabled aria-label="QR listo">
                        <div class="btn-content">
                            <div class="btn-qr-title">¬°Tu foto est√° lista!</div>
                            <div class="btn-qr-container">
                                <img id="qr-code-img" 
                                     alt="C√≥digo QR para descargar tu foto. Escanea con tu m√≥vil para acceder a la descarga."
                                     role="img"
                                     aria-label="C√≥digo QR de descarga">
                            </div>
                            <p class="btn-message">
                                Escanea el QR para descargar tu foto.
                            </p>
                        </div>
                    </button>
                </div>

                <!-- STATE: ERROR -->
                <div class="state-error hidden" id="state-error" role="alert">
                    <div class="error-icon" aria-hidden="true">‚ö†Ô∏è</div>
                    <p class="error-message">
                        Ha ocurrido un error inesperado.
                    </p>
                    <button class="btn-primary" id="retry-btn" aria-label="Reintentar captura">
                        Reintentar
                    </button>
                </div>
            </div>
        </main>

        <!-- FOOTER -->
        <footer class="footer" role="contentinfo">
            <p class="footer-text">
                Tus datos no se almacenan m√°s all√° del evento. Solicita borrado si lo necesitas.
            </p>
        </footer>
    </div>

    <!-- TOAST CONTAINER -->
    <div id="toast-container" aria-live="polite" aria-atomic="true"></div>

    <!-- Canvas para animaci√≥n de olas -->
    <canvas id="waves-canvas"></canvas>

    <!-- Elementos para animaci√≥n de reinicio -->
    <div class="reset-overlay" id="reset-overlay"></div>
    <div class="reset-circle" id="reset-circle"></div>
    <div class="reset-sweep" id="reset-sweep"></div>
    <div class="reset-message" id="reset-message">REINICIANDO...</div>

    <!-- QRCode Library -->
    <script src="https://unpkg.com/qrcode@1.5.3/build/qrcode.min.js" 
            crossorigin="anonymous"
            onerror="window.QRCodeLoadFailed = true;"></script>

    <script>
        // ============================================
        // CONSTANTS & STATE
        // ============================================
        let countdownInterval = null;
        let resetTimeout = null;
        const COUNTDOWN_DURATION = 10; // 10 segundos
        const RESET_UI_TIMEOUT = 30000; // 30 segundos (30 minutos = 1800000)
        
        // WebSocket connection
        let wsConnection = null;
        // WebSocket URL - Se adapta autom√°ticamente a HTTP/HTTPS y ws/wss
        const WS_URL = (window.location.protocol === 'https:' ? 'wss://' : 'ws://') + window.location.host;

        // ============================================
        // DOM SELECTORS
        // ============================================
        const captureBtn = document.getElementById('capture-btn');
        const retryBtn = document.getElementById('retry-btn');
        const openLinkBtn = document.getElementById('open-link-btn');
        
        const stateIdle = document.getElementById('state-idle');
        const stateCountdown = document.getElementById('state-countdown');
        const stateReady = document.getElementById('state-ready');
        const stateError = document.getElementById('state-error');
        
        const countdownDisplay = document.getElementById('countdown-display');
        const countdownMessage = document.getElementById('countdown-message');
        const loadingSpinner = document.getElementById('loading-spinner');
        const qrCodeImg = document.getElementById('qr-code-img');
        const toastContainer = document.getElementById('toast-container');

        // ============================================
        // STATE MANAGEMENT
        // ============================================
        function showState(stateElement) {
            [stateIdle, stateCountdown, stateReady, stateError].forEach(el => {
                el.classList.add('hidden');
            });
            stateElement.classList.remove('hidden');
        }

        function resetUI() {
            // Activar animaci√≥n de reinicio antes de resetear
            playResetAnimation();
            
            // Esperar a que termine la animaci√≥n antes de resetear el UI
            setTimeout(() => {
                clearInterval(countdownInterval);
                clearTimeout(resetTimeout);
                countdownInterval = null;
                resetTimeout = null;
                if (countdownDisplay) {
                    countdownDisplay.textContent = '';
                    countdownDisplay.style.display = 'block';
                }
                if (countdownMessage) countdownMessage.textContent = '';
                if (loadingSpinner) {
                    loadingSpinner.classList.remove('active');
                }
                if (qrCodeImg) qrCodeImg.src = '';
                captureBtn.disabled = false;
                showState(stateIdle);
                
                // UI reseteada al estado inicial
            }, 600); // Esperar medio segundo para que la animaci√≥n se vea bien
        }

        // ============================================
        // ANIMACI√ìN DE REINICIO
        // ============================================
        function playResetAnimation() {
            const overlay = document.getElementById('reset-overlay');
            const circle = document.getElementById('reset-circle');
            const sweep = document.getElementById('reset-sweep');
            const message = document.getElementById('reset-message');
            
            // Activar todas las animaciones simult√°neamente
            if (overlay) {
                overlay.classList.remove('active');
                // Forzar reflow para reiniciar la animaci√≥n
                void overlay.offsetWidth;
                overlay.classList.add('active');
            }
            
            if (circle) {
                circle.classList.remove('active');
                void circle.offsetWidth;
                circle.classList.add('active');
            }
            
            if (sweep) {
                sweep.classList.remove('active');
                void sweep.offsetWidth;
                sweep.classList.add('active');
            }
            
            if (message) {
                message.classList.remove('active');
                void message.offsetWidth;
                message.classList.add('active');
            }
            
            // Dispersar murci√©lagos al reiniciar (efecto de "reset")
            if (wavesAnimation) {
                const centerX = window.innerWidth / 2;
                const centerY = window.innerHeight / 2;
                // Crear murci√©lagos que se dispersan en todas las direcciones
                wavesAnimation.triggerBats(centerX, centerY, 'high');
            }
            
            // Remover clases despu√©s de la animaci√≥n
            setTimeout(() => {
                if (overlay) overlay.classList.remove('active');
                if (circle) circle.classList.remove('active');
                if (sweep) sweep.classList.remove('active');
                if (message) message.classList.remove('active');
            }, 1200);
        }

        // ============================================
        // TOAST NOTIFICATIONS
        // ============================================
        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.setAttribute('role', 'status');
            toast.setAttribute('aria-live', 'assertive');
            
            const icon = type === 'success' ? '‚úì' : '‚ö†';
            toast.innerHTML = `<span>${icon}</span><span>${message}</span>`;
            
            toastContainer.appendChild(toast);
            
            setTimeout(() => {
                toast.style.animation = 'slideUp 0.3s ease reverse';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // ============================================
        // COUNTDOWN
        // ============================================
        function startCountdown(duration) {
            showState(stateCountdown);
            let timeLeft = duration;
            countdownDisplay.textContent = timeLeft;
            countdownDisplay.setAttribute('aria-label', `Cuenta atr√°s: ${timeLeft} segundos`);
            
            // Mostrar mensaje "Mantente listo..." desde el inicio
            countdownMessage.textContent = 'Mantente listo, tu foto se est√° creando‚Ä¶';

            countdownInterval = setInterval(() => {
                timeLeft--;
                countdownDisplay.textContent = timeLeft;
                countdownDisplay.setAttribute('aria-label', `Cuenta atr√°s: ${timeLeft} segundos`);
                
                if (timeLeft <= 0) {
                    clearInterval(countdownInterval);
                    countdownInterval = null;
                    // Ocultar el n√∫mero y mostrar el spinner de carga
                    countdownDisplay.textContent = '';
                    countdownDisplay.style.display = 'none';
                    
                    // Mostrar spinner de carga
                    if (loadingSpinner) {
                        loadingSpinner.classList.add('active');
                    }
                    
                    // Mantener el mensaje visible por 10 segundos m√°s antes de mostrar QR
                    setTimeout(() => {
                        // Ocultar spinner antes de mostrar QR
                        if (loadingSpinner) {
                            loadingSpinner.classList.remove('active');
                        }
                        showQR();
                    }, 10000); // 10 segundos adicionales con el mensaje
                }
            }, 1000);
        }

        // ============================================
        // GENERATE AND SHOW QR
        // ============================================
        function showQR() {
            // Verificar que QRCode est√© disponible
            if (typeof QRCode === 'undefined' || window.QRCodeLoadFailed) {
                // Silenciosamente usar placeholder si QRCode no est√° disponible
                const placeholderQR = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjgwIiBoZWlnaHQ9IjI4MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMjgwIiBoZWlnaHQ9IjI4MCIgZmlsbD0iI2ZmZiIvPjx0ZXh0IHg9IjUwJSIgeT0iNTAlIiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMjQiIGZpbGw9IiMwMDAiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGR5PSIuM2VtIj5RUiBQcm90b3R5cG88L3RleHQ+PC9zdmc+';
                qrCodeImg.src = placeholderQR;
                showState(stateReady);
                showToast('Tu foto est√° lista', 'success');
                
                // A√±adir animaci√≥n especial tambi√©n para placeholder
                const qrContainer = document.querySelector('.btn-qr-container');
                if (qrContainer) {
                    qrContainer.classList.add('qr-appearing');
                    for (let i = 0; i < 3; i++) {
                        setTimeout(() => {
                            const ripple = document.createElement('div');
                            ripple.className = 'qr-ripple';
                            ripple.style.animationDelay = `${i * 0.2}s`;
                            qrContainer.appendChild(ripple);
                            setTimeout(() => {
                                if (ripple.parentNode) ripple.remove();
                            }, 2000);
                        }, i * 200);
                    }
                    setTimeout(() => {
                        qrContainer.classList.remove('qr-appearing');
                    }, 2000);
                }
                
                // Murci√©lagos cuando aparece el QR placeholder
                if (wavesAnimation) {
                    const centerX = window.innerWidth / 2;
                    const centerY = window.innerHeight / 2;
                    wavesAnimation.triggerBats(centerX, centerY, 'high');
                }
                
                resetTimeout = setTimeout(() => {
                    console.log("Reseteando aplicaci√≥n despu√©s de 30 segundos...");
                    resetUI();
                }, RESET_UI_TIMEOUT);
                return;
            }
            
            // Generar un ID √∫nico para esta sesi√≥n
            const sessionId = Date.now().toString(36) + Math.random().toString(36).substr(2);
            const redirectUrl = `${window.location.origin}/d/${sessionId}`;
            
            // Generar QR falso usando la librer√≠a QRCode
            try {
                    QRCode.toDataURL(redirectUrl, {
                        width: 160,
                        margin: 1,
                        color: {
                            dark: '#000000',
                            light: '#FFFFFF'
                        },
                        errorCorrectionLevel: 'H'
                    }, (err, qrDataUrl) => {
                    if (err) {
                        // Silenciosamente usar placeholder si falla la generaci√≥n
                        // Usar placeholder si falla
                        const placeholderQR = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjgwIiBoZWlnaHQ9IjI4MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMjgwIiBoZWlnaHQ9IjI4MCIgZmlsbD0iI2ZmZiIvPjx0ZXh0IHg9IjUwJSIgeT0iNTAlIiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMjQiIGZpbGw9IiMwMDAiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGR5PSIuM2VtIj5RUiBQcm90b3R5cG88L3RleHQ+PC9zdmc+';
                        qrCodeImg.src = placeholderQR;
                        showState(stateReady);
                        showToast('Tu foto est√° lista', 'success');
                        
                        // A√±adir animaci√≥n especial tambi√©n para error
                        const qrContainer = document.querySelector('.btn-qr-container');
                        if (qrContainer) {
                            qrContainer.classList.add('qr-appearing');
                            for (let i = 0; i < 3; i++) {
                                setTimeout(() => {
                                    const ripple = document.createElement('div');
                                    ripple.className = 'qr-ripple';
                                    ripple.style.animationDelay = `${i * 0.2}s`;
                                    qrContainer.appendChild(ripple);
                                    setTimeout(() => {
                                        if (ripple.parentNode) ripple.remove();
                                    }, 2000);
                                }, i * 200);
                            }
                            setTimeout(() => {
                                qrContainer.classList.remove('qr-appearing');
                            }, 2000);
                        }
                        
                        // Murci√©lagos cuando aparece el QR de error
                        if (wavesAnimation) {
                            const centerX = window.innerWidth / 2;
                            const centerY = window.innerHeight / 2;
                            wavesAnimation.triggerBats(centerX, centerY, 'high');
                        }
                        
                        resetTimeout = setTimeout(() => {
                            resetUI();
                        }, RESET_UI_TIMEOUT);
                        return;
                    }
                    
                    // Mostrar el QR dentro del bot√≥n
                    qrCodeImg.onload = () => {
                        showState(stateReady);
                        showToast('Tu foto est√° lista', 'success');
                        
                        // Obtener el contenedor del QR
                        const qrContainer = document.querySelector('.btn-qr-container');
                        
                        // A√±adir animaci√≥n especial cuando aparece el QR
                        if (qrContainer) {
                            // A√±adir clase de animaci√≥n
                            qrContainer.classList.add('qr-appearing');
                            
                            // Crear ondas conc√©ntricas m√∫ltiples
                            for (let i = 0; i < 3; i++) {
                                setTimeout(() => {
                                    const ripple = document.createElement('div');
                                    ripple.className = 'qr-ripple';
                                    ripple.style.animationDelay = `${i * 0.2}s`;
                                    qrContainer.appendChild(ripple);
                                    
                                    // Remover despu√©s de la animaci√≥n
                                    setTimeout(() => {
                                        if (ripple.parentNode) {
                                            ripple.remove();
                                        }
                                    }, 2000);
                                }, i * 200);
                            }
                            
                            // Remover clase de animaci√≥n despu√©s de completarse
                            setTimeout(() => {
                                qrContainer.classList.remove('qr-appearing');
                            }, 2000);
                        }
                        
                        // Murci√©lagos cuando aparece el QR
                        if (wavesAnimation) {
                            const centerX = window.innerWidth / 2;
                            const centerY = window.innerHeight / 2;
                            wavesAnimation.triggerBats(centerX, centerY, 'high');
                        }
                        
                        // Anunciar para lectores de pantalla
                        const announcement = document.createElement('div');
                        announcement.className = 'sr-only';
                        announcement.setAttribute('role', 'status');
                        announcement.setAttribute('aria-live', 'assertive');
                        announcement.textContent = 'Tu foto est√° lista. Escanea el c√≥digo QR para descargarla.';
                        document.body.appendChild(announcement);
                        setTimeout(() => announcement.remove(), 1000);
                    };
                    
                    qrCodeImg.onerror = () => {
                        // Silenciosamente usar placeholder si falla la carga
                        const placeholderQR = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjgwIiBoZWlnaHQ9IjI4MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMjgwIiBoZWlnaHQ9IjI4MCIgZmlsbD0iI2ZmZiIvPjx0ZXh0IHg9IjUwJSIgeT0iNTAlIiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMjQiIGZpbGw9IiMwMDAiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGR5PSIuM2VtIj5RUiBQcm90b3R5cG88L3RleHQ+PC9zdmc+';
                        qrCodeImg.src = placeholderQR;
                        showState(stateReady);
                    };
                    
                    qrCodeImg.src = qrDataUrl;
                    
                    // Programar reseteo despu√©s de 30 segundos
                    resetTimeout = setTimeout(() => {
                        resetUI();
                    }, RESET_UI_TIMEOUT);
                });
            } catch (error) {
                // Silenciosamente usar placeholder si hay error
                const placeholderQR = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjgwIiBoZWlnaHQ9IjI4MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMjgwIiBoZWlnaHQ9IjI4MCIgZmlsbD0iI2ZmZiIvPjx0ZXh0IHg9IjUwJSIgeT0iNTAlIiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMjQiIGZpbGw9IiMwMDAiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGR5PSIuM2VtIj5RUiBQcm90b3R5cG88L3RleHQ+PC9zdmc+';
                qrCodeImg.src = placeholderQR;
                showState(stateReady);
                showToast('Tu foto est√° lista', 'success');
                
                // A√±adir animaci√≥n especial
                const qrContainer = document.querySelector('.btn-qr-container');
                if (qrContainer) {
                    qrContainer.classList.add('qr-appearing');
                    setTimeout(() => qrContainer.classList.remove('qr-appearing'), 2000);
                }
                
                resetTimeout = setTimeout(() => {
                    resetUI();
                }, RESET_UI_TIMEOUT);
            }
        }

        // ============================================
        // ERROR HANDLING
        // ============================================
        function showError(message) {
            showState(stateError);
            showToast(message, 'error');
        }

        // ============================================
        // WEBSOCKET CONNECTION
        // ============================================
        let wsReconnectAttempts = 0;
        const MAX_WS_RECONNECT_ATTEMPTS = 3;
        let wsReconnectTimeout = null;

        function connectWebSocket() {
            // No intentar conectar si ya hay demasiados intentos fallidos
            if (wsReconnectAttempts >= MAX_WS_RECONNECT_ATTEMPTS) {
                return; // Silenciosamente dejar de intentar
            }

            try {
                wsConnection = new WebSocket(WS_URL);
                
                wsConnection.onopen = () => {
                    console.log('[WebSocket] Conectado al servidor');
                    wsReconnectAttempts = 0; // Resetear contador al conectar exitosamente
                };
                
                wsConnection.onmessage = (event) => {
                    try {
                        const data = JSON.parse(event.data);
                        
                        // Solo loggear mensajes importantes
                        if (data.type === 'connected') {
                            console.log('[WebSocket] Conectado:', data.message);
                        }
                    } catch (error) {
                        // Silenciosamente manejar errores de parsing
                    }
                };
                
                wsConnection.onerror = (error) => {
                    // No loggear errores de WebSocket si el servidor no est√° disponible
                    // Esto es normal cuando se usa el modo prototipo sin backend
                    wsReconnectAttempts++;
                };
                
                wsConnection.onclose = () => {
                    // Solo intentar reconectar si no hemos excedido el l√≠mite
                    if (wsReconnectAttempts < MAX_WS_RECONNECT_ATTEMPTS) {
                        wsReconnectTimeout = setTimeout(() => {
                            connectWebSocket();
                        }, 3000);
                    }
                    // Si excedimos el l√≠mite, silenciosamente dejar de intentar
                };
            } catch (error) {
                // Silenciosamente manejar errores de creaci√≥n de WebSocket
                wsReconnectAttempts++;
            }
        }
        
        function sendWebSocketMessage(message) {
            if (wsConnection && wsConnection.readyState === WebSocket.OPEN) {
                try {
                    wsConnection.send(JSON.stringify(message));
                    return true;
                } catch (error) {
                    return false;
                }
            }
            return false; // Silenciosamente fallar si no hay conexi√≥n
        }

        // ============================================
        // CAPTURE HANDLER
        // ============================================
        function handleCaptureClick() {
            if (captureBtn.disabled) return;
            
            captureBtn.disabled = true;
            // Iniciando captura
            
            // Trigger murci√©lagos desde el bot√≥n (MUCHOS al hacer click)
            if (wavesAnimation) {
                const centerX = window.innerWidth / 2;
                const centerY = window.innerHeight / 2;
                wavesAnimation.triggerBats(centerX, centerY, 'high');
            }
            
            // Enviar mensaje WebSocket a TouchDesigner
            const captureMessage = {
                type: 'capture',
                timestamp: Date.now(),
                countdownSec: COUNTDOWN_DURATION
            };
            
            // Intentar enviar por WebSocket, si falla el backend lo manejar√° v√≠a POST
            sendWebSocketMessage(captureMessage);
            
            // Tambi√©n hacer POST /api/capture para crear el jobId
            // (El backend tambi√©n enviar√° el mensaje WebSocket, pero es redundante si ya lo enviamos aqu√≠)
            // Por ahora mantenemos el POST para mantener compatibilidad
            fetch('/api/capture', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                // Job creado exitosamente
            })
            .catch(error => {
                // Silenciosamente manejar errores de red (normal en modo prototipo)
            });
            
            // Iniciar cuenta atr√°s de 10 segundos directamente
            startCountdown(COUNTDOWN_DURATION);
        }

        // ============================================
        // EVENT LISTENERS
        // ============================================
        captureBtn.addEventListener('click', handleCaptureClick);
        retryBtn.addEventListener('click', () => {
            resetUI();
            setTimeout(() => handleCaptureClick(), 100);
        });

        // Keyboard support
        captureBtn.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' || e.key === ' ') {
                e.preventDefault();
                handleCaptureClick();
            }
        });

        // ============================================
        // WAVES ANIMATION
        // ============================================
        class WavesAnimation {
            constructor(canvas) {
                this.canvas = canvas;
                this.ctx = canvas.getContext('2d');
                this.waves = [];
                this.bats = [];
                this.animationId = null;
                
                // Forma del murci√©lago extra√≠da del JSON Lottie (puntos del path)
                this.batShape = [
                    [-70.0, 0.0],
                    [-55.0, -20.0],
                    [-40.0, -25.0],
                    [-20.0, -15.0],
                    [-10.0, -5.0],
                    [-5.0, -20.0],
                    [0.0, -35.0],
                    [5.0, -20.0],
                    [10.0, -5.0],
                    [20.0, -15.0],
                    [40.0, -25.0],
                    [55.0, -20.0],
                    [70.0, 0.0],
                    [50.0, 10.0],
                    [30.0, 25.0],
                    [10.0, 30.0],
                    [0.0, 20.0],
                    [-10.0, 30.0],
                    [-30.0, 25.0],
                    [-50.0, 10.0]
                ];
                
                this.resize();
                window.addEventListener('resize', () => this.resize());
                
                // Crear olas iniciales
                this.createWaves();
                this.animate();
            }
            
            resize() {
                this.canvas.width = window.innerWidth;
                this.canvas.height = window.innerHeight;
                // Recrear olas con nuevas posiciones basadas en el nuevo tama√±o
                this.createWaves();
            }
            
            createWaves() {
                // Olas con perspectiva 3D (vista desde arriba)
                this.waves = [
                    {
                        centerX: this.canvas.width * 0.3,
                        centerY: this.canvas.height * 0.3,
                        radius: 150,
                        amplitude: 25,
                        frequency: 0.02,
                        speed: 0.015,
                        phase: 0,
                        color: 'rgba(0, 224, 255, 0.25)',
                        depth: 0.8
                    },
                    {
                        centerX: this.canvas.width * 0.7,
                        centerY: this.canvas.height * 0.5,
                        radius: 180,
                        amplitude: 30,
                        frequency: 0.018,
                        speed: 0.012,
                        phase: Math.PI / 3,
                        color: 'rgba(0, 224, 255, 0.2)',
                        depth: 0.7
                    },
                    {
                        centerX: this.canvas.width * 0.5,
                        centerY: this.canvas.height * 0.7,
                        radius: 200,
                        amplitude: 35,
                        frequency: 0.015,
                        speed: 0.01,
                        phase: Math.PI / 2,
                        color: 'rgba(0, 224, 255, 0.15)',
                        depth: 0.6
                    },
                    {
                        centerX: this.canvas.width * 0.2,
                        centerY: this.canvas.height * 0.8,
                        radius: 120,
                        amplitude: 20,
                        frequency: 0.022,
                        speed: 0.018,
                        phase: Math.PI,
                        color: 'rgba(0, 224, 255, 0.12)',
                        depth: 0.9
                    }
                ];
            }
            
            addBat(startX, startY, count = 1) {
                // Limitar n√∫mero total de murci√©lagos para mejor rendimiento
                if (this.bats.length > 80) {
                    return; // No agregar m√°s si ya hay muchos
                }
                
                // Crear m√∫ltiples murci√©lagos con trayectorias mejoradas y naturales
                for (let i = 0; i < count; i++) {
                    // √Ångulo base con variaci√≥n para crear efecto de enjambre
                    const baseAngle = Math.random() * Math.PI * 2;
                    const speed = 3 + Math.random() * 4; // Velocidad m√°s variada
                    const maxDistance = Math.max(this.canvas.width, this.canvas.height) * 1.5;
                    const offsetAngle = (Math.PI * 2 / count) * i;
                    const spreadRadius = 30; // Radio de dispersi√≥n inicial
                    
                    // Trayectoria con curva natural (vuelo m√°s realista)
                    const curveAmount = 0.3 + Math.random() * 0.4; // Cantidad de curva
                    const curveDirection = Math.random() > 0.5 ? 1 : -1;
                    
                    // Velocidad inicial con componente de curva
                    let vx = Math.cos(baseAngle) * speed;
                    let vy = Math.sin(baseAngle) * speed;
                    
                    // A√±adir componente de curva para vuelo m√°s natural
                    const perpendicularAngle = baseAngle + (Math.PI / 2) * curveDirection;
                    vx += Math.cos(perpendicularAngle) * speed * curveAmount * 0.3;
                    vy += Math.sin(perpendicularAngle) * speed * curveAmount * 0.3;
                    
                    // √Ångulo inicial basado en direcci√≥n de movimiento
                    const rotationAngle = Math.atan2(vy, vx);
                    
                    this.bats.push({
                        x: startX + Math.cos(offsetAngle) * spreadRadius,
                        y: startY + Math.sin(offsetAngle) * spreadRadius,
                        vx: vx,
                        vy: vy,
                        angle: rotationAngle,
                        distance: 0,
                        maxDistance: maxDistance,
                        size: 20 + Math.random() * 12, // Tama√±o m√°s variado
                        opacity: 1,
                        wingPhase: Math.random() * Math.PI * 2,
                        wingSpeed: 0.3 + Math.random() * 0.25, // Animaci√≥n de alas m√°s r√°pida
                        glow: 0.85 + Math.random() * 0.15, // Glow m√°s variado
                        color: `rgba(0, 224, 255, 1)`,
                        curveAmount: curveAmount, // Guardar para aplicar curva continua
                        curveDirection: curveDirection
                    });
                }
            }
            
            drawWave(wave) {
                // Dibujar ola con perspectiva 3D (vista desde arriba)
                const segments = 64;
                const points = [];
                
                // Calcular puntos de la ola circular con altura 3D
                for (let i = 0; i <= segments; i++) {
                    const angle = (Math.PI * 2 / segments) * i;
                    const distance = wave.radius;
                    
                    // Altura de la ola basada en el √°ngulo y fase
                    const height = Math.sin((angle * wave.frequency * 10) + wave.phase) * wave.amplitude;
                    
                    // Posici√≥n 2D proyectada desde perspectiva 3D
                    const x = wave.centerX + Math.cos(angle) * distance;
                    const y = wave.centerY + Math.sin(angle) * distance;
                    
                    // Ajustar posici√≥n Y basado en altura (simular profundidad)
                    const depthY = y + (height * wave.depth);
                    
                    points.push({ x, y: depthY, height });
                }
                
                // Dibujar c√≠rculos conc√©ntricos para efecto 3D
                for (let ring = 0; ring < 3; ring++) {
                    const ringRadius = wave.radius - (ring * 20);
                    const ringAmplitude = wave.amplitude * (1 - ring * 0.3);
                    
                    this.ctx.beginPath();
                    
                    for (let i = 0; i <= segments; i++) {
                        const angle = (Math.PI * 2 / segments) * i;
                        const height = Math.sin((angle * wave.frequency * 10) + wave.phase) * ringAmplitude;
                        const x = wave.centerX + Math.cos(angle) * ringRadius;
                        const y = wave.centerY + Math.sin(angle) * ringRadius + (height * wave.depth);
                        
                        if (i === 0) {
                            this.ctx.moveTo(x, y);
                        } else {
                            this.ctx.lineTo(x, y);
                        }
                    }
                    
                    this.ctx.closePath();
                    
                    // Gradiente radial para efecto 3D
                    const gradient = this.ctx.createRadialGradient(
                        wave.centerX, wave.centerY, 0,
                        wave.centerX, wave.centerY, ringRadius + ringAmplitude
                    );
                    // Extraer opacidad del color rgba
                    const opacityMatch = wave.color.match(/rgba?\([^)]+,\s*([\d.]+)\)/);
                    const baseOpacity = opacityMatch ? parseFloat(opacityMatch[1]) : 0.2;
                    const ringOpacity = baseOpacity * (1 - ring * 0.2);
                    gradient.addColorStop(0, `rgba(0, 224, 255, ${ringOpacity})`);
                    gradient.addColorStop(0.7, `rgba(0, 224, 255, ${ringOpacity * 0.5})`);
                    gradient.addColorStop(1, 'rgba(0, 224, 255, 0)');
                    
                    this.ctx.fillStyle = gradient;
                    this.ctx.fill();
                }
                
                // Dibujar l√≠neas de contorno para definir mejor la forma
                this.ctx.beginPath();
                for (let i = 0; i <= segments; i++) {
                    const angle = (Math.PI * 2 / segments) * i;
                    const height = Math.sin((angle * wave.frequency * 10) + wave.phase) * wave.amplitude;
                    const x = wave.centerX + Math.cos(angle) * wave.radius;
                    const y = wave.centerY + Math.sin(angle) * wave.radius + (height * wave.depth);
                    
                    if (i === 0) {
                        this.ctx.moveTo(x, y);
                    } else {
                        this.ctx.lineTo(x, y);
                    }
                }
                this.ctx.closePath();
                this.ctx.strokeStyle = wave.color;
                this.ctx.lineWidth = 1;
                this.ctx.stroke();
            }
            
            drawBat(bat) {
                // Aplicar curva continua al vuelo para movimiento m√°s natural
                if (bat.curveAmount !== undefined) {
                    const perpendicularAngle = Math.atan2(bat.vy, bat.vx) + (Math.PI / 2) * bat.curveDirection;
                    const curveForce = bat.curveAmount * 0.15;
                    bat.vx += Math.cos(perpendicularAngle) * curveForce;
                    bat.vy += Math.sin(perpendicularAngle) * curveForce;
                    
                    // Normalizar velocidad para mantener velocidad constante
                    const currentSpeed = Math.sqrt(bat.vx * bat.vx + bat.vy * bat.vy);
                    const baseSpeed = 3 + Math.random() * 4;
                    if (currentSpeed > 0) {
                        bat.vx = (bat.vx / currentSpeed) * baseSpeed;
                        bat.vy = (bat.vy / currentSpeed) * baseSpeed;
                    }
                }
                
                // Actualizar posici√≥n y animaci√≥n de alas
                bat.x += bat.vx;
                bat.y += bat.vy;
                bat.distance += Math.sqrt(bat.vx * bat.vx + bat.vy * bat.vy);
                bat.wingPhase += bat.wingSpeed;
                
                // Rotaci√≥n suave basada en direcci√≥n de movimiento (m√°s natural)
                const targetAngle = Math.atan2(bat.vy, bat.vx);
                // Interpolaci√≥n suave para rotaci√≥n m√°s fluida
                const angleDiff = targetAngle - bat.angle;
                // Normalizar diferencia de √°ngulo
                let normalizedDiff = angleDiff;
                while (normalizedDiff > Math.PI) normalizedDiff -= Math.PI * 2;
                while (normalizedDiff < -Math.PI) normalizedDiff += Math.PI * 2;
                bat.angle += normalizedDiff * 0.15; // Suavizar rotaci√≥n
                
                // Reducir opacidad con la distancia
                bat.opacity = Math.max(0, 1 - (bat.distance / bat.maxDistance));
                
                // Eliminar murci√©lagos que est√°n muy lejos o muy transparentes (se desaparecen)
                if (bat.distance > bat.maxDistance || bat.opacity < 0.02) {
                    return false; // Se elimina del array
                }
                
                // Guardar contexto
                this.ctx.save();
                
                // Aplicar glow INTENSO mejorado
                const glowIntensity = bat.opacity * bat.glow;
                this.ctx.globalAlpha = bat.opacity;
                
                // Dibujar murci√©lago usando la forma exacta del JSON Lottie
                this.ctx.translate(bat.x, bat.y);
                this.ctx.rotate(bat.angle);
                
                // Escalar los puntos del path seg√∫n el tama√±o del murci√©lago
                // El path original tiene un tama√±o base de ~140px (de -70 a +70)
                const scale = bat.size / 140; // Normalizar al tama√±o del murci√©lago
                
                // Color s√≥lido negro con glow ne√≥n mejorado
                this.ctx.fillStyle = '#000000';
                this.ctx.strokeStyle = `rgba(0, 224, 255, ${bat.opacity * 0.8})`;
                this.ctx.lineWidth = 1.5;
                
                // Glow principal cian
                this.ctx.shadowBlur = 40 * bat.glow;
                this.ctx.shadowColor = `rgba(0, 224, 255, ${glowIntensity})`;
                
                // Animaci√≥n de alas usando escala Y para simular movimiento
                const wingSpread = Math.sin(bat.wingPhase) * 0.3 + 0.7; // 0.7 a 1.0 (m√°s sutil)
                const wingScaleY = wingSpread; // Escalar verticalmente para efecto de alas
                
                // Dibujar el path del murci√©lago escalado y animado
                this.ctx.beginPath();
                const points = this.batShape;
                
                // Primer punto
                this.ctx.moveTo(points[0][0] * scale, points[0][1] * scale * wingScaleY);
                
                // Dibujar el resto de los puntos con animaci√≥n de alas
                for (let i = 1; i < points.length; i++) {
                    const [x, y] = points[i];
                    // Aplicar escala y animaci√≥n de alas (solo en Y para efecto de vuelo)
                    const scaledX = x * scale;
                    const scaledY = y * scale * wingScaleY;
                    this.ctx.lineTo(scaledX, scaledY);
                }
                
                // Cerrar el path
                this.ctx.closePath();
                this.ctx.fill();
                this.ctx.stroke();
                
                // Restaurar contexto
                this.ctx.restore();
                
                return true;
            }
            
            drawBats() {
                // Limitar n√∫mero de murci√©lagos activos para mejor rendimiento
                if (this.bats.length > 80) {
                    // Eliminar los m√°s antiguos si hay demasiados
                    this.bats = this.bats.slice(-80);
                }
                // Filtrar y dibujar murci√©lagos (los que retornan false se eliminan)
                this.bats = this.bats.filter(bat => this.drawBat(bat));
            }
            
            animate() {
                // Limpiar canvas
                this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
                
                // ANIMACI√ìN DE OLAS (independiente, siempre activa)
                this.waves.forEach(wave => {
                    wave.phase += wave.speed;
                    this.drawWave(wave);
                });
                
                // ANIMACI√ìN DE MURCI√âLAGOS (independiente, solo cuando hay)
                if (this.bats.length > 0) {
                    this.drawBats();
                }
                
                this.animationId = requestAnimationFrame(() => this.animate());
            }
            
            triggerBats(x, y, intensity = 'normal') {
                // Usar las coordenadas proporcionadas o el centro del canvas como fallback
                const startX = x !== undefined ? x : this.canvas.width / 2;
                const startY = y !== undefined ? y : this.canvas.height / 2;
                
                // N√∫mero de murci√©lagos seg√∫n intensidad
                let batCount = 15;
                if (intensity === 'high') batCount = 25;
                
                // Generar murci√©lagos en r√°fagas escalonadas para efecto de enjambre
                for (let i = 0; i < batCount; i++) {
                    setTimeout(() => {
                        // Crear grupos de 2-4 murci√©lagos a la vez
                        const groupSize = 2 + Math.floor(Math.random() * 3);
                        this.addBat(startX, startY, groupSize);
                    }, i * 40);
                }
                
                // NO modificar las olas - animaciones independientes
            }
        }
        
        let wavesAnimation;

        // ============================================
        // CURSOR TRACKING & PARTICLE EFFECTS
        // ============================================
        function setupButtonCursorTracking(button) {
            const particlesContainer = button.querySelector('.particles');
            if (!particlesContainer) return;
            
            let mouseX = 0;
            let mouseY = 0;
            let isInside = false;
            let particleInterval = null;
            
            // Obtener el pseudo-elemento ::before para mover la luz
            const style = window.getComputedStyle(button, '::before');
            
            // Actualizar posici√≥n de la luz seg√∫n el cursor
            function updateLightPosition(e) {
                const rect = button.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                
                mouseX = x;
                mouseY = y;
                
                // Actualizar posici√≥n del ::before usando CSS custom properties
                button.style.setProperty('--cursor-x', `${x}px`);
                button.style.setProperty('--cursor-y', `${y}px`);
            }
            
            // Crear part√≠cula desde el cursor
            function createParticleFromCursor(x, y) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                
                // Posici√≥n inicial (donde est√° el cursor)
                particle.style.left = `${x}px`;
                particle.style.top = `${y}px`;
                
                // Direcci√≥n aleatoria desde el cursor
                const angle = Math.random() * Math.PI * 2;
                const distance = 30 + Math.random() * 50;
                const tx = Math.cos(angle) * distance;
                const ty = Math.sin(angle) * distance;
                
                particle.style.setProperty('--tx', `${tx}px`);
                particle.style.setProperty('--ty', `${ty}px`);
                
                particlesContainer.appendChild(particle);
                
                // Remover despu√©s de la animaci√≥n
                setTimeout(() => {
                    if (particle.parentNode) {
                        particle.remove();
                    }
                }, 1500);
            }
            
            // Crear part√≠culas desde el punto de clic/touch
            function createClickParticles(x, y) {
                const particleCount = 12;
                
                // Crear efecto de ondas
                const ripple = document.createElement('div');
                ripple.className = 'click-ripple';
                ripple.style.left = `${x}px`;
                ripple.style.top = `${y}px`;
                button.appendChild(ripple);
                
                setTimeout(() => {
                    if (ripple.parentNode) {
                        ripple.remove();
                    }
                }, 600);
                
                // Crear m√∫ltiples part√≠culas desde el punto de clic
                for (let i = 0; i < particleCount; i++) {
                    setTimeout(() => {
                        createParticleFromCursor(x, y);
                    }, i * 30);
                }
            }
            
            // Mouse move - seguir cursor
            button.addEventListener('mousemove', (e) => {
                updateLightPosition(e);
                isInside = true;
            });
            
            // Mouse enter
            button.addEventListener('mouseenter', (e) => {
                isInside = true;
                updateLightPosition(e);
                
                // Crear part√≠culas continuamente mientras el cursor est√° dentro
                particleInterval = setInterval(() => {
                    if (isInside && !button.disabled) {
                        createParticleFromCursor(mouseX, mouseY);
                    }
                }, 150); // Cada 150ms
            });
            
            // Mouse leave
            button.addEventListener('mouseleave', () => {
                isInside = false;
                if (particleInterval) {
                    clearInterval(particleInterval);
                    particleInterval = null;
                }
            });
            
            // Click/Touch - crear part√≠culas desde el punto de contacto
            button.addEventListener('click', (e) => {
                const rect = button.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                createClickParticles(x, y);
            });
            
            // Touch support
            button.addEventListener('touchstart', (e) => {
                const touch = e.touches[0];
                const rect = button.getBoundingClientRect();
                const x = touch.clientX - rect.left;
                const y = touch.clientY - rect.top;
                updateLightPosition({ clientX: touch.clientX, clientY: touch.clientY });
                createClickParticles(x, y);
            });
            
            button.addEventListener('touchmove', (e) => {
                const touch = e.touches[0];
                updateLightPosition({ clientX: touch.clientX, clientY: touch.clientY });
            });
        }

        // ============================================
        // INITIALIZATION
        // ============================================
        showState(stateIdle);
        
        // Conectar WebSocket al servidor
        connectWebSocket();
        
        // Inicializar animaci√≥n de olas
        const wavesCanvas = document.getElementById('waves-canvas');
        if (wavesCanvas) {
            wavesAnimation = new WavesAnimation(wavesCanvas);
        }
        
        // Configurar seguimiento de cursor y part√≠culas en todos los botones
        const allButtons = document.querySelectorAll('.btn-primary');
        allButtons.forEach(button => {
            setupButtonCursorTracking(button);
        });

        // Verificar que QRCode est√© cargado (solo en modo desarrollo)
        if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
            window.addEventListener('load', () => {
                if (typeof QRCode === 'undefined' || window.QRCodeLoadFailed) {
                    console.info('QRCode library no disponible - usando placeholder (esto es normal en modo prototipo)');
                }
            });
        }

        // Cleanup on page hide
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                // Mantener intervalos activos para que el proceso contin√∫e
            }
        });
    </script>
</body>
</html>

</html>
